<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Topo Map Export - Demo B</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; }
        select, input { padding: 8px; width: 100%; max-width: 300px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .validation-box { margin: 15px 0; padding: 12px; border-radius: 4px; display: none; }
        .validation-box.warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; display: block; }
        .validation-box.error { background: #f8d7da; border: 1px solid #dc3545; color: #721c24; display: block; }
        .validation-box.info { background: #d1ecf1; border: 1px solid #17a2b8; color: #0c5460; display: block; }
        .validation-box ul { margin: 5px 0 0 20px; padding: 0; }
        .preset-info { font-size: 0.85em; color: #666; margin-top: 4px; }
        .preset-info strong { color: #333; }
    </style>
</head>
<body>
    <h1>Topo Map Export - Demo B</h1>
    <form id="export-form">
        <div class="form-group">
            <label>Theme:</label>
            <select id="theme" name="theme">
                <option value="paper">Loading...</option>
            </select>
        </div>
        <div class="form-group">
            <label>Bbox Preset:</label>
            <select id="bbox_preset" name="bbox_preset">
                <option value="stockholm_core">Stockholm Core</option>
                <option value="stockholm_wide">Stockholm Wide</option>
                <option value="svealand">Svealand</option>
            </select>
            <div class="preset-info" id="preset-info"></div>
        </div>
        <div class="form-group">
            <label>Render Mode:</label>
            <select id="render_mode" name="render_mode">
                <option value="print">Print</option>
                <option value="screen">Screen</option>
            </select>
        </div>
        <div class="form-group">
            <label>DPI:</label>
            <input type="number" id="dpi" name="dpi" value="150" min="150" max="300">
        </div>
        <div class="form-group">
            <label>Width (mm):</label>
            <input type="number" id="width_mm" name="width_mm" value="420">
        </div>
        <div class="form-group">
            <label>Height (mm):</label>
            <input type="number" id="height_mm" name="height_mm" value="594">
        </div>
        <div class="form-group">
            <label>Format:</label>
            <select id="format" name="format">
                <option value="png">PNG</option>
                <option value="pdf">PDF</option>
            </select>
        </div>
        <div class="form-group">
            <label>Layers:</label>
            <div>
                <label><input type="checkbox" id="layer-hillshade" checked> Hillshade</label><br>
                <label><input type="checkbox" id="layer-water" checked> Water</label><br>
                <label><input type="checkbox" id="layer-parks" checked> Parks</label><br>
                <label><input type="checkbox" id="layer-roads" checked> Roads</label><br>
                <label><input type="checkbox" id="layer-buildings" checked> Buildings</label><br>
                <label><input type="checkbox" id="layer-contours" checked> Contours</label>
            </div>
        </div>
        <div id="validation-box" class="validation-box"></div>
        <button type="submit" id="export-btn">Export</button>
    </form>

    <script>
        // Global state
        let presetLimits = null;
        let currentValidation = { valid: true, warnings: [], error: null };

        // Load preset limits
        fetch('/api/preset-limits')
            .then(r => r.json())
            .then(limits => {
                presetLimits = limits;
                updatePresetInfo();
                validateCurrentSettings();
            })
            .catch(err => console.error('Failed to load preset limits:', err));

        // Load themes dynamically
        fetch('/api/themes')
            .then(r => r.json())
            .then(themes => {
                const select = document.getElementById('theme');
                const currentValue = select.value;
                select.innerHTML = '';
                themes.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    select.appendChild(opt);
                });
                if (currentValue && themes.some(t => t.id === currentValue)) {
                    select.value = currentValue;
                } else if (themes.some(t => t.id === 'paper')) {
                    select.value = 'paper';
                } else if (themes.length > 0) {
                    select.value = themes[0].id;
                }
            })
            .catch(err => console.error('Failed to load themes:', err));

        // Update preset info display
        function updatePresetInfo() {
            if (!presetLimits || !presetLimits.presets) return;

            const preset = document.getElementById('bbox_preset').value;
            const presetConfig = presetLimits.presets[preset];
            const infoEl = document.getElementById('preset-info');

            if (presetConfig) {
                const limits = presetConfig.limits || {};
                const data = presetConfig.data_requirements || {};
                infoEl.innerHTML = `
                    <strong>Complexity:</strong> ${presetConfig.complexity || 'unknown'} |
                    <strong>Max DPI:</strong> ${limits.max_dpi || 'N/A'} |
                    <strong>Formats:</strong> ${(limits.allowed_formats || []).join(', ')} |
                    <strong>Build time:</strong> ~${data.build_time_minutes || '?'} min
                `;
            } else {
                infoEl.innerHTML = '';
            }
        }

        // Validate current form settings
        async function validateCurrentSettings() {
            const preset = document.getElementById('bbox_preset').value;
            const dpi = parseInt(document.getElementById('dpi').value);
            const width_mm = parseInt(document.getElementById('width_mm').value);
            const height_mm = parseInt(document.getElementById('height_mm').value);

            try {
                const response = await fetch('/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bbox_preset: preset, dpi, width_mm, height_mm })
                });
                currentValidation = await response.json();
            } catch (err) {
                currentValidation = { valid: true, warnings: [], error: null };
            }

            updateValidationDisplay();
        }

        // Update validation display
        function updateValidationDisplay() {
            const box = document.getElementById('validation-box');
            const btn = document.getElementById('export-btn');

            box.className = 'validation-box';
            box.innerHTML = '';

            if (!currentValidation.valid && currentValidation.error) {
                box.className = 'validation-box error';
                box.innerHTML = `<strong>Cannot export:</strong> ${currentValidation.error}`;
                btn.disabled = true;
            } else if (currentValidation.warnings && currentValidation.warnings.length > 0) {
                box.className = 'validation-box warning';
                box.innerHTML = '<strong>Warnings:</strong><ul>' +
                    currentValidation.warnings.map(w => `<li>${w}</li>`).join('') +
                    '</ul>';
                btn.disabled = false;
            } else if (currentValidation.info) {
                const info = currentValidation.info;
                box.className = 'validation-box info';
                box.innerHTML = `<strong>Output:</strong> ${info.width_px} x ${info.height_px} px` +
                    (info.detected_format ? ` (${info.detected_format})` : '') +
                    (info.estimated_render_time ? ` | Est. time: ${info.estimated_render_time}s` : '');
                btn.disabled = false;
            } else {
                btn.disabled = false;
            }
        }

        // Add event listeners for validation
        ['bbox_preset', 'dpi', 'width_mm', 'height_mm'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                updatePresetInfo();
                validateCurrentSettings();
            });
        });

        document.getElementById('export-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const themeSelect = document.getElementById('theme');
            const themeValue = themeSelect.value;

            if (!themeValue || themeValue === 'Loading...') {
                alert('Please wait for themes to load, or select a theme');
                return;
            }

            // Check validation before proceeding
            if (!currentValidation.valid) {
                alert('Export not allowed: ' + currentValidation.error);
                return;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.theme = themeValue;
            data.dpi = parseInt(data.dpi);
            data.width_mm = parseInt(data.width_mm);
            data.height_mm = parseInt(data.height_mm);

            data.layers = {
                hillshade: document.getElementById('layer-hillshade').checked,
                water: document.getElementById('layer-water').checked,
                parks: document.getElementById('layer-parks').checked,
                roads: document.getElementById('layer-roads').checked,
                buildings: document.getElementById('layer-buildings').checked,
                contours: document.getElementById('layer-contours').checked
            };

            const btn = document.getElementById('export-btn');
            btn.disabled = true;
            btn.textContent = 'Exporting...';

            try {
                const renderResponse = await fetch('/api/render', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!renderResponse.ok) {
                    const contentType = renderResponse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorJson = await renderResponse.json();
                        throw new Error(errorJson.error || 'Export failed');
                    }
                    const errorText = await renderResponse.text();
                    throw new Error(errorText);
                }

                const blob = await renderResponse.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `export.${data.format}`;
                a.click();
            } catch (error) {
                alert('Export failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Export';
            }
        });

        // Initial preset info update
        updatePresetInfo();
    </script>
</body>
</html>

